# Functional Behavior Guide

## Recommendation priorities
- **Category-first sort order.** Recommendations default to category sorting that respects the priority groups in `CATEGORY_PRIORITY_GROUPS`, falling back to case-insensitive category names within different groups, rarity, then name. Quick-use items use a bench-specific priority keyed by slug so benches stay grouped in their operational order.【F:src/lib/recommend.ts†L27-L489】
- **Action resolution chain.** Items start as `sell` with a generic rationale. Quest requirements force `keep`; outstanding workbench upgrades, projects, or wishlist links also switch to `keep` and aggregate reasons. Admin-configured always-keep categories likewise yield `keep`. Otherwise, recycle beats selling whenever it feeds wishlist/upgrade/project targets from salvage outputs or simply pays more than the vendor price; remaining cases stay `sell`. Rationale is amended when wishlist sources exist so the player sees the dependency chain.【F:src/lib/recommend.ts†L278-L372】
- **Wishlist and search handling.** The recommendation context derives wishlist sources from explicit want-list entries plus dependency expansion, then applies them during keep/recycle rationale building. Query filtering respects ignored categories unless the item is explicitly on the wishlist. Weapon variants are deduped before recommendation calculations so variants do not crowd the results.【F:src/lib/recommend.ts†L97-L184】【F:src/lib/recommend.ts†L398-L433】
- **Quest/upgrade/project needs.** Quest needs ignore completed quests; upgrade needs only count unowned workbench levels; project needs stop at the earliest incomplete phase when tallying remaining quantities. Recycle recommendations also look through salvage outputs to satisfy any of these needs before considering raw value.【F:src/lib/recommend.ts†L187-L276】【F:src/lib/recommend.ts†L340-L366】

## State interactions that drive recommendations
- **Quest progress.** The quest store persists completion flags and supports toggling or upserting progress. Recommendation inputs ignore completed quests by design, so resetting or hydrating quest progress directly changes which items become `keep` vs. `sell`/`recycle`.【F:src/lib/stores/app.ts†L382-L406】【F:src/lib/recommend.ts†L187-L208】
- **Workbench upgrades.** Upgrade ownership is tracked per level, and only unowned upgrades contribute to `keep` rationales. Toggling ownership immediately prunes those needs from recommendations and hides them from recycle prioritization.【F:src/lib/stores/app.ts†L427-L444】【F:src/lib/recommend.ts†L211-L240】【F:src/lib/recommend.ts†L340-L359】
- **Projects and phases.** Project progress is stored per project/phase/item, and contribution updates remove empty phases or projects. Recommendations only consider the first incomplete phase per project, so marking contributions advances the checklist and can downgrade items from `keep`/`recycle` back to `sell`.【F:src/lib/stores/app.ts†L654-L696】【F:src/lib/recommend.ts†L243-L276】
- **Blueprint and want-list effects.** Blueprint ownership and want-list entries are persisted with debounce-backed storage. The want list merges quantities and sanitized reasons, supports dependency expansion, and feeds wishlist source derivation, which affects both search filtering (ignored categories are bypassed for wishlist entries) and the rationale strings for `keep`/`recycle`.【F:src/lib/stores/app.ts†L103-L119】【F:src/lib/stores/app.ts†L408-L444】【F:src/lib/stores/app.ts†L595-L652】【F:src/lib/recommend.ts†L97-L184】【F:src/lib/recommend.ts†L398-L433】
- **Settings influence.** Admin settings persist always-keep categories and ignored want categories; the recommendation context ingests these values to flip items to `keep` or to bypass category filters. Sorting preference (category vs. alphabetical) flows through the recommendation sort switch.【F:src/lib/stores/app.ts†L522-L567】【F:src/lib/recommend.ts†L278-L366】【F:src/lib/recommend.ts†L398-L489】

## Run logging and sorting
- **Run log semantics.** Runs are stored and sorted newest-first by start time after every add/update/remove/restore. Derived helpers expose the last-removed entry for undo, and all mutations debounce to local storage alongside other app state.【F:src/lib/stores/app.ts†L446-L518】

## Exceptions and legacy behaviors
- **Weapon variant deduplication.** Recommendations collapse weapon variants before sorting or action assignment to avoid duplicate entries surfacing; this remains for backwards compatibility with legacy item feeds that exposed multiple slugs for the same weapon.【F:src/lib/recommend.ts†L398-L433】
